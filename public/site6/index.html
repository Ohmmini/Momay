<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Momay Energy Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    /* Authentication Modal Styles */
    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* ดาว */
    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      opacity: 0.8;
      animation: twinkle infinite alternate;
    }

    @keyframes twinkle {
      from {
        opacity: 0.2;
        transform: scale(1);
      }

      to {
        opacity: 1;
        transform: scale(1.3);
      }
    }

    .auth-modal {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      min-width: 350px;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .auth-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
      font-weight: 700;
    }

    .auth-title {
      font-size: 1.8rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .auth-subtitle {
      color: #64748b;
      margin-bottom: 30px;
      font-size: 0.9rem;
    }

    .auth-input {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      text-align: center;
    }

    .auth-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .auth-button {
      width: 100%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 15px;
    }

    .auth-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .remember-me {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      font-size: 0.9rem;
      color: #64748b;
    }

    .remember-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid #e2e8f0;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .remember-checkbox.checked {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-color: #667eea;
    }

    .remember-checkbox.checked::after {
      content: '✓';
      position: absolute;
      color: white;
      font-size: 12px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-bottom: 20px;
      display: none;
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .dashboard-container.authenticated {
      opacity: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .logo {
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      font-size: 2rem;
      color: #667eea;
      font-weight: 700;
    }

    .logomain {
      width: 200px;
      height: 200px;
      background: white;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      font-size: 2rem;
      color: #667eea;
      font-weight: 700;
    }

    .main-title {
      color: white;
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1rem;
      font-weight: 400;
    }

    /* Logout button */
    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      font-size: 0.9rem;
      z-index: 1000;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    /* Date Selector Styles */
    .date-selector {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .period-tabs {
      display: flex;
      gap: 10px;
      justify-content: center;
      background: #f8fafc;
      padding: 8px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .period-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      max-width: 120px;
    }

    .period-tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .period-tab:hover:not(.active) {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }

    .date-navigation {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .nav-arrow {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: #667eea;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      transition: all 0.3s ease;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-arrow:hover {
      background: rgba(102, 126, 234, 0.1);
      transform: scale(1.1);
    }

    .current-date {
      font-size: 1.5rem;
      font-weight: 600;
      color: #2d3748;
      min-width: 200px;
      text-align: center;
      cursor: pointer;
      padding: 10px 20px;
      border-radius: 10px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .current-date:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    .building-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .building-header {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
    }

    .building-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      color: white;
      font-size: 1.5rem;
    }

    .building-title {
      font-size: 1.8rem;
      font-weight: 600;
      color: #2d3748;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #16a34a;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 16px;
      padding: 25px;
      color: white;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
      border-radius: 16px;
    }

    .metric-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .metric-unit {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .chart-container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #2d3748;
    }

    .date-display {
      background: #f7fafc;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      color: #4a5568;
      font-weight: 500;
    }

    /* Data Type Selector Styles */
    .data-type-selector {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px 20px;
      background: #f8fafc;
      border-radius: 15px;
      border: 2px solid #e2e8f0;
    }

    .selector-label {
      font-weight: 600;
      color: #2d3748;
      font-size: 0.9rem;
    }

    @keyframes gradientShift {
      0% {
        border-color: #0052df;
        color: #0052df;
        box-shadow: 0 0 5px #0052df;
      }

      50% {
        border-color: #1e90ff;
        color: #1e90ff;
        box-shadow: 0 0 15px #1e90ff;
      }

      100% {
        border-color: #0052df;
        color: #0052df;
        box-shadow: 0 0 5px #0052df;
      }
    }

    .data-type-dropdown {
      flex: 1;
      max-width: 300px;
      padding: 10px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      background: white;
      font-size: 0.9rem;
      font-weight: 600;
      color: #000000;
      cursor: pointer;
      transition: all 0.3s ease;
      animation: gradientShift 3s infinite;
    }

    .data-type-dropdown:hover,
    .data-type-dropdown:focus {
      animation-play-state: paused;
      border-color: #003bb3;
      color: #003bb3;
      box-shadow: 0 0 20px #003bb3;
      outline: none;
    }


    .data-type-dropdown:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .data-type-dropdown:hover {
      border-color: #cbd5e0;
    }

    .chart-canvas-wrapper {
      position: relative;
      height: 400px;
      margin-bottom: 20px;
    }

    .chart-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #4fd1c7, #06b6d4);
    }

    .btn-secondary:hover {
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
    }

    .action-bar {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }

    .action-btn {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #f093fb, #f5576c);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .action-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 1000;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    .modal-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #2d3748;
    }

    .date-input {
      width: 200px;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      text-align: center;
      margin-bottom: 20px;
      transition: border-color 0.3s ease;
    }

    .date-input:focus {
      border-color: #667eea;
      outline: none;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: #9ca3af;
      font-size: 1.1rem;
    }

    .loading::before {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Mobile Responsive Design (มือถือ) */
    @media (max-width: 767px) {
      .dashboard-container {
        padding: 8px;
      }

      .auth-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 110%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }


      .auth-modal {
        margin: 20px;
        padding: 30px 25px;
        min-width: auto;
        min-height: 50px;
        width: calc(100% - 40px);
      }

      .main-title {
        font-size: 2rem;
      }

      .building-section,
      .date-selector {
        padding: 20px;
      }

      .period-tabs {
        flex-direction: column;
        gap: 8px;
      }

      .period-tab {
        max-width: none;
      }

      .date-navigation {
        gap: 20px;
      }

      .current-date {
        font-size: 0.9rem;
        min-width: 150px;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .metric-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 16px;
        padding: 25px;
        color: white;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
      }

      .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
        border-radius: 16px;
      }

      .metric-label {
        font-size: 0.8rem;
        opacity: 0.8;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .metric-unit {
        font-size: 0.8rem;
        opacity: 0.7;
      }

      .chart-canvas-wrapper {
        width: 120%;
        height: 100%;
        margin-left: -10%;
      }

      .chart-controls {
        flex-direction: column;
      }

      .action-bar {
        flex-wrap: wrap;
        gap: 12px;
      }

      .chart-container {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0px;
      }

      .chart-title {
        font-size: 0.6rem;
        font-weight: 800;
        color: #2d3748;
      }

      .modal-content {
        margin: 20px;
        padding: 25px 20px;
        border-radius: 16px;
        max-width: 90vw;
      }

      .date-input {
        width: 100%;
        max-width: 250px;
      }

      .modal-buttons {
        flex-direction: column;
        gap: 10px;
      }

      .modal-buttons .btn {
        width: 100%;
      }

      .data-type-selector {
        display: flex;
        align-items: center;
        gap: 7px;
        margin-bottom: 10px;
        padding: 7px 10px;
        background: #f8fafc;
        border-radius: 7px;
        border: 1px solid #e2e8f0;
      }


      .selector-label {
        font-weight: 400;
        color: #2d3748;
        font-size: 0.6rem;
      }

      .data-type-dropdown {
        flex: 1;
        max-width: 100px;
        padding: 5px 7px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        background: white;
        font-size: 0.6rem;
        font-weight: 600;
        color: #000000;
        cursor: pointer;
        transition: all 0.3s ease;
        animation: gradientShift 3s infinite;
      }

      .date-display {
        background: #f7fafc;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.5rem;
        color: #4a5568;
        font-weight: 500;
      }

    }

    /* Tablet Responsive Design (iPad) */
    @media (min-width: 768px) and (max-width: 1024px) {
      .dashboard-container {
        padding: 20px 30px;
        max-width: 1000px;
      }

      .main-title {
        font-size: 2.2rem;
      }

      .period-tabs {
        gap: 12px;
      }

      .metrics-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }

      .chart-canvas-wrapper {
        width: 100% !important;
        height: 300px !important;
        margin: 0 auto;
      }

      .btn {
        padding: 14px 28px;
        font-size: 1rem;
      }

      .data-type-dropdown {
        max-width: none;
        font-size: 0.8rem;
        /* ลดขนาดฟอนต์ลง */
        padding: 8px 12px;
        /* ลด padding */
        height: auto;
        /* ปรับความสูงให้พอดี */
      }
    }

    #back-button {
      font-size: 2rem;
      color: #667eea;
      text-decoration: none;
      user-select: none;
      cursor: pointer;
      padding-right: 0.5rem;
      margin-left: 20px;
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
      }

      .building-section,
      .date-selector {
        background: rgba(45, 55, 72, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .chart-container {
        background: #2d3748;
      }

      .building-title,
      .chart-title {
        color: #f7fafc;
      }

      .date-display {
        background: #4a5568;
        color: #f7fafc;
      }

      .modal-content {
        background: #2d3748;
        color: #f7fafc;
      }

      .modal-title {
        color: #f7fafc;
      }

      .date-input {
        background: #4a5568;
        border-color: #718096;
        color: #f7fafc;
      }

      .current-date {
        color: #f7fafc;
      }

      .period-tabs {
        background: #4a5568;
      }

      .data-type-selector {
        background: #4a5568;
        border-color: #718096;
      }

      .selector-label {
        color: #fcf7f7;
      }

      .data-type-dropdown {
        background: #2d3748;
        border-color: #718096;
        color: #f7fafc;
      }
    }

    .User {
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
      text-align: center;
      margin: 20px 0;
      letter-spacing: 1px;
      font-family: 'Inter', sans-serif;

      display: inline-block;
      padding: 5px 20px;
      border-radius: 12px;

      border: 2px solid rgba(255, 255, 255, 0.7);
      /* กรอบสีขาวโปร่ง */
      background: transparent;
      /* ไม่มีพื้นหลัง */

    }

    .notify-bell {
      position: fixed;
      top: 20px;
      right: 120px;
      z-index: 1000;
      width: 46px;
      height: 46px;
      border: none;
      cursor: pointer;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      backdrop-filter: blur(10px);
      transition: all .2s ease;
      font-size: 1.1rem;
    }

    .notify-bell:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.3);
    }

    .notify-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: #ef4444;
      color: #fff;
      font-size: 12px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, .2);
    }

    .notify-panel {
      position: fixed;
      top: 76px;
      right: 20px;
      z-index: 1000;
      width: 320px;
      max-height: 60vh;
      overflow: auto;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .25);
      backdrop-filter: blur(12px);
    }

    .notify-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      font-weight: 600;
      color: #2d3748;
      border-bottom: 1px solid rgba(0, 0, 0, .06);
    }

    .notify-clear {
      border: none;
      background: transparent;
      color: #64748b;
      cursor: pointer;
    }

    .notify-list {
      padding: 8px 10px;
    }

    .notify-item {
      display: flex;
      gap: 10px;
      padding: 10px;
      border-radius: 10px;
      margin: 6px 0;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      font-size: .9rem;
      color: #1f2937;
    }

    .notify-item .icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 28px;
    }

    .icon-peak {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
    }

    .icon-anom {
      background: linear-gradient(135deg, #f97316, #ef4444);
      color: #fff;
    }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 24px;
      z-index: 1000;
      background: rgba(17, 24, 39, .92);
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: .9rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }

    @media (prefers-color-scheme: dark) {
      .notify-panel {
        background: rgba(45, 55, 72, 0.95);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .notify-panel-header {
        color: #f7fafc;
        border-bottom-color: rgba(255, 255, 255, 0.08);
      }

      .notify-item {
        background: #2d3748;
        border-color: #475569;
        color: #f7fafc;
      }

      .notify-bell {
        background: rgba(255, 255, 255, 0.12);
      }
    }
  </style>
</head>

<body>

  <!-- Authentication Overlay -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-modal">
      <div class="auth-logo"><img src="/static/momay.png" alt="Logo"
          style="width:200%; height:150%; border-radius:50%; object-fit:contain; background:#fff;"> </div>
      <h2 class="auth-title">please login</h2>
      <p class="auth-subtitle">Please enter the access code to view the Momay dashboard</p>

      <div id="errorMessage" class="error-message">
        Invalid access code. Please try again.
      </div>

      <input type="password" id="accessCode" class="auth-input" placeholder="Enter Access Code" maxlength="20">

      <button onclick="authenticate()" class="auth-button">
        Access Dashboard
      </button>

      <div class="remember-me">
        <div id="rememberCheckbox" class="remember-checkbox" onclick="toggleRemember()"></div>
        <span>Remember me for 7 days</span>
      </div>
    </div>
  </div>


  <!-- Logout Button -->
  <button id="logoutBtn" class="logout-btn" onclick="logout()" style="display: none;">
    <i class="fas fa-sign-out-alt"></i> Logout
  </button>

  <!-- Notification Bell -->
  <button id="notifyBell" class="notify-bell" title="Notifications">
    <i class="fas fa-bell"></i>
    <span id="notifyBadge" class="notify-badge" style="display:none;">0</span>
  </button>

  <!-- Notification Panel -->
  <div id="notifyPanel" class="notify-panel" style="display:none;">
    <div class="notify-panel-header">
      <span>Notifications</span>
      <button id="notifyClear" class="notify-clear">Clear</button>
    </div>
    <div id="notifyList" class="notify-list"></div>
  </div>

  <button class="nav-arrow" onclick="window.location.href='/opening'" style="display: none;" id="backButton">
    <i class="fas fa-chevron-left"></i>
  </button>

  <div class="dashboard-container" id="dashboardContainer">
    <div class="header">
      <a href="https://kwangunlimit.com">
        <div class="logomain"
          style="width:200px; height:200px; border-radius:50%; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center;">
          <img src="./picture/kwang_logo2.png" alt="Logo"
            style="width:110%; height:110%; border-radius:50%; object-fit:contain; background:#fff;">
        </div>
      </a>

      <a href="https://www.kwangunlimit.com/renewablesort/momay">
        <div class="logo"
          style="width:100px; height:100px; border-radius:50%; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center;">
          <img src="./picture/momay.png" alt="Logo"
            style="width:100%; height:100%; border-radius:50%; object-fit:contain; background:#fff;">
        </div>
      </a>
      <h1 class="main-title">Momay Energy Monitoring</h1>
      <p class="subtitle">Real-time energy consumption tracking and analytics</p>
      <p class="User">Beauty Clinic</p>
    </div>


    <!-- Building 1 Section -->
    <div class="building-section">
      <!-- Date Selector -->
      <div class="date-selector">
        <div class="date-navigation">
          <button class="nav-arrow" onclick="navigateDate(-1)">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="current-date" onclick="openDatePicker()">
            <span id="currentDateDisplay">10/08/2025</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <button class="nav-arrow" onclick="navigateDate(1)">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>


        <div class="building-header">
          <div>
            <h2 class="building-title">อาคาร 1</h2>
            <div class="status-indicator">
              <div class="status-dot"></div>
              <span>Live Monitoring</span>
            </div>
          </div>
        </div>

        <div class="metrics-grid">

          <div class="metric-card" id="billBox1"
            data-description="การใช้พลังงานไฟฟ้าของวันนี้&#10;คำนวนจาก&#10;การรวมค่ากำลังไฟฟ้าทุก 15 นาที x 0.25 ชั่วโมง แล้วบวกสะสมไปจนครบ 24 ชั่วโมง เพื่อหาพลังงานรวมในหน่วย kWh">
            <div class="metric-label">Daily Energy</div>
            <div class="metric-value" id="daily-energy">-</div>
            <div class="metric-unit">kWh</div>
          </div>




          <div class="metric-card" id="monthBox1"
            data-description="การใช้พลังงานไฟฟ้าของเดือนนี้&#10;คำนวนจาก&#10;การนำค่าพลังงานรวมของแต่ละวัน x จำนวนวันของเดือนนั้นๆ">
            <div class="metric-label">Monthly Energy</div>
            <div class="metric-value" id="monthly-energy">-</div>
            <div class="metric-unit">kWh</div>
          </div>


          <div class="metric-card" id="yearBox1"
            data-description="การใช้พลังงานไฟฟ้าของปีนี้&#10;คำนวนจาก&#10;การนำค่าพลังงานรวมของแต่ละเดือน x 12">
            <div class="metric-label">Yearly Energy</div>
            <div class="metric-value">-</div>
            <div class="metric-unit">kWh</div>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title" id="chartTitle1">Energy Consumption</h3>
            <div class="date-display" id="dateDisplay1">Loading...</div>
          </div>

          <!-- Data Type Selector -->
          <div class="data-type-selector">
            <label class="selector-label">Display Data:</label>
            <select class="data-type-dropdown" id="dataTypeSelector1" onchange="changeDataType(1)">
              <option value="current">Current AVG</option>
              <option value="power" selected>Power</option>
              <option value="voltage">Voltage AVG</option>

            </select>
          </div>

          <div class="chart-canvas-wrapper">
            <canvas id="energyChart1"></canvas>
          </div>

        </div>
      </div>

    </div>

  </div>
  </div>

  <!-- Date Picker Modal -->
  <div id="dateModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">Select Date for Historical Data</h3>
      <input id="datePicker" type="date" class="date-input" placeholder="Select Date">
      <div class="modal-buttons">
        <button class="btn" onclick="fetchHistoricalData()">
          <i class="fas fa-check"></i>
          Load Data
        </button>
        <button class="btn" onclick="closeModal()" style="background: #6b7280;">
          <i class="fas fa-times"></i>
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Authentication System
    const ACCESS_CODE = "240124"; // รหัสผ่าน
    let rememberMe = false;

    // Check authentication on page load
    function checkAuth() {
      const savedAuth = JSON.parse(localStorage.getItem('momayAuth') || '{}');
      const now = new Date().getTime();

      if (savedAuth.authenticated && savedAuth.expiry > now) {
        showDashboard();
        return true;
      } else {
        showAuthModal();
        return false;
      }
    }

    // ------------------ CONFIG: กฎ/เกณฑ์แจ้งเตือน ------------------
    const ALERT_RULES = {
      allowedHours: { start: 8, end: 22 },          // แจ้งเฉพาะ 08:00–22:00
      voltageRange: { min: 200, max: 250 },         // V
      currentMax: 80,                                // A
      powerSpikePct: 50,                             // เพิ่มขึ้น > % จากค่าเฉลี่ย 5 นาที
      keepLastAlerts: 50,                            // เก็บ log ใน localStorage
      endpointKey: 'Clinic'                          // ใช้กับคีย์ localStorage ต่อวัน
    };

    // ------------------ STATE ------------------
    let notifEnabled = false;
    let lastTimestampByBuilding = {}; // {1: '2025-...'}
    let movingBufferByBuilding = {};  // เก็บค่า power นาทีล่าสุด (สูงสุด ~5 นาที)
    let inAppAlerts = [];             // แสดงในพาเนล

    // ------------------ Utilities ------------------
    function withinNotifyHours(d = new Date()) {
      const h = d.getHours();
      return (h >= ALERT_RULES.allowedHours.start && h < ALERT_RULES.allowedHours.end);
    }
    function requestNotifyPermission() {
      if (!('Notification' in window)) return;
      Notification.requestPermission().then(p => { notifEnabled = (p === 'granted'); });
    }
    function showSystemNotification(title, body) {
      if (notifEnabled && withinNotifyHours()) {
        try { new Notification(title, { body }); } catch { }
      } else {
        // Fallback toast ในหน้า
        showToast(`${title}: ${body}`);
      }
    }
    let toastTimer;
    function showToast(msg) {
      clearTimeout(toastTimer);
      let t = document.getElementById('__toast__');
      if (!t) { t = document.createElement('div'); t.id = '__toast__'; t.className = 'toast'; document.body.appendChild(t); }
      t.textContent = msg;
      t.style.display = 'block';
      toastTimer = setTimeout(() => { t.style.display = 'none'; }, 3500);
    }
    function addInAppAlert(type, message) {
      const iconClass = type === 'peak' ? 'icon-peak' : 'icon-anom';
      inAppAlerts.unshift({ type, message, ts: new Date().toLocaleString() });
      inAppAlerts = inAppAlerts.slice(0, ALERT_RULES.keepLastAlerts);
      // persist
      localStorage.setItem('momayAlerts', JSON.stringify(inAppAlerts));
      // render
      const list = document.getElementById('notifyList');
      if (list) {
        const item = document.createElement('div');
        item.className = 'notify-item';
        item.innerHTML = `<div class="icon ${iconClass}"><i class="fas fa-bolt"></i></div>
      <div><div style="font-weight:600;">${message}</div><div style="opacity:.7;font-size:.8rem;">${new Date().toLocaleString()}</div></div>`;
        list.prepend(item);
      }
      // badge
      const badge = document.getElementById('notifyBadge');
      if (badge) {
        const cnt = (parseInt(badge.textContent || '0', 10) || 0) + 1;
        badge.textContent = cnt;
        badge.style.display = 'inline-flex';
      }
    }
    function loadInAppAlerts() {
      try {
        inAppAlerts = JSON.parse(localStorage.getItem('momayAlerts') || '[]');
      } catch { inAppAlerts = []; }
    }
    function renderAlertList() {
      const list = document.getElementById('notifyList');
      if (!list) return;
      list.innerHTML = '';
      inAppAlerts.forEach(a => {
        const iconClass = a.type === 'peak' ? 'icon-peak' : 'icon-anom';
        const div = document.createElement('div');
        div.className = 'notify-item';
        div.innerHTML = `<div class="icon ${iconClass}"><i class="fas fa-bolt"></i></div>
      <div><div style="font-weight:600;">${a.message}</div><div style="opacity:.7;font-size:.8rem;">${a.ts}</div></div>`;
        list.appendChild(div);
      });
      const badge = document.getElementById('notifyBadge');
      if (badge) {
        const cnt = inAppAlerts.length;
        if (cnt > 0) { badge.textContent = cnt; badge.style.display = 'inline-flex'; }
        else { badge.style.display = 'none'; }
      }
    }
    function setupNotifications() {
      // โหลดประวัติเดิม
      loadInAppAlerts();
      renderAlertList();
      // ปุ่มกระดิ่ง
      const bell = document.getElementById('notifyBell');
      const panel = document.getElementById('notifyPanel');
      const clearBtn = document.getElementById('notifyClear');
      if (bell) {
        bell.addEventListener('click', () => {
          // ขอสิทธิ Notification ครั้งแรก
          if (!notifEnabled && ('Notification' in window) && Notification.permission !== 'granted') {
            requestNotifyPermission();
          }
          panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
        });
      }
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          inAppAlerts = [];
          localStorage.setItem('momayAlerts', '[]');
          renderAlertList();
          showToast('Notifications cleared');
        });
      }
      // คลิกนอก panel เพื่อปิด
      document.addEventListener('click', (e) => {
        if (!panel) return;
        if (e.target.id === 'notifyBell' || e.target.closest('#notifyPanel') || e.target.closest('#notifyBell')) return;
        panel.style.display = 'none';
      });
    }

    // ใช้วันที่ตาม local timezone
    function localDateKey(d) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    // แจ้งเตือน peak ของ "พลังงานรายวัน (kWh)" โดยอิงข้อมูลล่าสุดจริง + debounce ราย 15 นาที
    function checkDailyEnergyPeak(buildingId, data) {
      if (!Array.isArray(data) || data.length === 0) return;

      // เรียงเวลาให้ชัวร์
      data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      const last = data[data.length - 1];
      const lastTs = new Date(last.timestamp);              // ใช้เวลาในข้อมูลจริง
      const dateKey = localDateKey(lastTs);                 // key วันแบบ local (ไม่ใช้ toISOString())
      const bucket = Math.floor(lastTs.getTime() / (15 * 60 * 1000)); // bucket 15 นาที (debounce)

      // คำนวณ daily energy จาก data (ฟังก์ชันของคุณที่ "ไม่แตะ UI")
      const energyKWh = calculateDailyEnergyFromData(data);

      // กันแจ้งซ้ำ: ต้องเป็นบักเก็ตใหม่ และต้องมากกว่า peak เดิมพอสมควร (เช่น 0.1 kWh)
      const keyEnergy = `peakEnergy_${dateKey}_B${buildingId}`;
      const keyBucket = `peakEnergy_bucket_${dateKey}_B${buildingId}`;
      const prevEnergy = parseFloat(localStorage.getItem(keyEnergy) || '-1');
      const prevBucket = localStorage.getItem(keyBucket);

      if (energyKWh > 0 && energyKWh > (isNaN(prevEnergy) ? -1 : prevEnergy) + 0.099 && String(bucket) !== prevBucket) {
        localStorage.setItem(keyEnergy, energyKWh.toFixed(2));
        localStorage.setItem(keyBucket, String(bucket));

        const msg = `New daily peak ${energyKWh.toFixed(2)} kWh (Building ${buildingId})`;
        addInAppAlert('peak', msg);
        showSystemNotification('Daily Energy Peak', msg);
      }
    }


    // ------------------ Anomaly Detector ------------------
    function updateMovingBuffer(buildingId, newPower) {
      if (!movingBufferByBuilding[buildingId]) movingBufferByBuilding[buildingId] = [];
      const buf = movingBufferByBuilding[buildingId];
      buf.push(newPower);
      // เก็บประมาณ 5 นาทีล่าสุด (สมมติข้อมูล 1 จุด/นาทีโดยเฉลี่ย)
      while (buf.length > 5) buf.shift();
      const avg = buf.reduce((s, v) => s + v, 0) / (buf.length || 1);
      return avg;
    }
    function checkAnomaly(buildingId, point) {
      const power = (point.active_power ?? point.power) ?? null;
      const voltage = point.voltage ?? null;
      const current = point.current ?? null;

      // 1) ช่วงแรงดันหลุด
      if (typeof voltage === 'number' && (voltage < ALERT_RULES.voltageRange.min || voltage > ALERT_RULES.voltageRange.max)) {
        const msg = `Voltage out of range: ${voltage.toFixed(0)} V (Building ${buildingId})`;
        addInAppAlert('anom', msg);
        showSystemNotification('Voltage anomaly', msg);
      }

      // 2) กระแสเกิน
      if (typeof current === 'number' && current > ALERT_RULES.currentMax) {
        const msg = `Current high: ${current.toFixed(1)} A (Building ${buildingId})`;
        addInAppAlert('anom', msg);
        showSystemNotification('Current anomaly', msg);
      }

      // 3) Power spike vs moving average (5 นาที)
      if (typeof power === 'number' && power > 0) {
        const avg = updateMovingBuffer(buildingId, power);
        if (avg > 0) {
          const pct = ((power - avg) / avg) * 100;
          if (pct >= ALERT_RULES.powerSpikePct) {
            const msg = `Power spike +${pct.toFixed(0)}% → ${power.toFixed(2)} kW (Building ${buildingId})`;
            addInAppAlert('anom', msg);
            showSystemNotification('Power spike', msg);
          }
        }
      }
    }
    function installNotificationHooks() {
      // ป้องกันติดตั้งซ้ำ
      if (installNotificationHooks.__installed) return;
      installNotificationHooks.__installed = true;

      // ต้องมีฟังก์ชันต้นฉบับก่อน
      if (typeof calculateAndUpdateDailyEnergy !== 'function' || typeof fetchRealTimeData !== 'function') {
        console.warn('[notify] base functions not ready, retry…');
        setTimeout(installNotificationHooks, 50);
        return;
      }

      // --- Hook: หลังคำนวณ daily energy เสร็จ ให้เช็ค peak แบบใหม่ ---
      const _orig_calculateAndUpdateDailyEnergy = calculateAndUpdateDailyEnergy;
      calculateAndUpdateDailyEnergy = function (buildingId, data) {
        try { _orig_calculateAndUpdateDailyEnergy(buildingId, data); } catch (e) { console.error(e); }
        try { checkDailyEnergyPeak(buildingId, data); } catch (e) { console.error('[notify] peak error', e); }
      };

      // --- Hook realtime: หลังดึงข้อมูล ให้ตรวจ anomaly และ (ถ้ามี) power-peak เพิ่มด้วยได้ ---
      const _orig_fetchRealTimeData = fetchRealTimeData;
      fetchRealTimeData = async function (buildingId, endpoint) {
        try {
          await _orig_fetchRealTimeData(buildingId, endpoint);
          const arr = (chartData && chartData[buildingId]) || [];
          if (!arr.length) return;

          // เรียก peak ของ daily energy อิงข้อมูลจริง (แก้ timezone + debounce แล้ว)
          checkDailyEnergyPeak(buildingId, arr);

          // ตรวจจุดล่าสุด (anomaly/power-peak ถ้าเปิดใช้)
          const last = arr[arr.length - 1];
          const ts = last.timestamp;
          if (ts && lastTimestampByBuilding[buildingId] !== ts) {
            lastTimestampByBuilding[buildingId] = ts;
            checkAnomaly(buildingId, last);
            // ถ้าต้องการแจ้ง peak ของ kW ให้เปิดฟังก์ชันนี้:
            // checkPowerPeak(buildingId, last);
          }
        } catch (e) {
          console.error('[notify] realtime hook error', e);
        }
      };


      console.log('[notify] hooks installed');
    }




    let peakPowerByDate = {};

    function checkPowerPeak(buildingId, point) {
      const dateKey = new Date(point.timestamp).toISOString().slice(0, 10);
      const key = `peakPower_${dateKey}_B${buildingId}`;
      const oldPeak = parseFloat(localStorage.getItem(key) || '0');
      const p = point.active_power || point.power || 0;
      if (p > oldPeak) {
        localStorage.setItem(key, p.toFixed(2));
        const msg = `New power peak ${p.toFixed(2)} kW (Building ${buildingId})`;
        addInAppAlert('peak', msg);
        showSystemNotification('Power Peak', msg);
      }
    }
    // Toggle remember me checkbox
    function toggleRemember() {
      rememberMe = !rememberMe;
      const checkbox = document.getElementById('rememberCheckbox');
      if (rememberMe) {
        checkbox.classList.add('checked');
      } else {
        checkbox.classList.remove('checked');
      }
    }


    // Authentication function
    function authenticate() {
      const enteredCode = document.getElementById('accessCode').value.trim();
      const errorMessage = document.getElementById('errorMessage');

      if (enteredCode === ACCESS_CODE) {
        // Successful authentication
        if (rememberMe) {
          const expiry = new Date().getTime() + (7 * 24 * 60 * 60 * 1000); // 7 days
          localStorage.setItem('momayAuth', JSON.stringify({
            authenticated: true,
            expiry: expiry
          }));
        }

        showDashboard();
        errorMessage.style.display = 'none';
      } else {
        // Failed authentication
        errorMessage.style.display = 'block';
        document.getElementById('accessCode').value = '';

        // Shake animation
        const modal = document.querySelector('.auth-modal');
        modal.style.animation = 'none';
        setTimeout(() => {
          modal.style.animation = 'slideUp 0.3s ease';
        }, 10);
      }
    }

    // Show dashboard
    function showDashboard() {
      document.getElementById('authOverlay').style.display = 'none';
      document.getElementById('dashboardContainer').classList.add('authenticated');
      document.getElementById('logoutBtn').style.display = 'block';
      document.getElementById('backButton').style.display = 'block';

      // Initialize dashboard only after authentication
      setTimeout(() => {
        initialize();
      }, 500);
    }

    // Show authentication modal
    function showAuthModal() {
      document.getElementById('authOverlay').style.display = 'flex';
      document.getElementById('dashboardContainer').classList.remove('authenticated');
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';

      // Focus on input
      setTimeout(() => {
        document.getElementById('accessCode').focus();
      }, 300);
    }

    // Logout function
    function logout() {
      localStorage.removeItem('momayAuth');
      document.getElementById('accessCode').value = '';
      document.getElementById('rememberCheckbox').classList.remove('checked');
      rememberMe = false;
      showAuthModal();

      // Clear any running intervals
      Object.values(realTimeIntervals).forEach(interval => {
        clearInterval(interval);
      });
    }

    // Handle Enter key in password input
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('accessCode').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          authenticate();
        }
      });
    });

    // Global variables
    let charts = {};
    let realTimeIntervals = {};
    let currentBuilding = 1;
    let currentPeriod = 'day';
    let currentDate = new Date();
    let currentDataType = { 1: 'power' };
    let chartData = { 1: [] };

    // Data type configuration
    const dataTypeConfig = {
      current: { label: 'Current AVG', unit: 'A', color: '#ff6b6b' },
      power: { label: 'Power', unit: 'kW', color: '#667eea' },
      active_power_phase_a: { label: 'Active Power Phase A', unit: 'kW', color: '#f093fb' },
      active_power_phase_b: { label: 'Active Power Phase B', unit: 'kW', color: '#4fd1c7' },
      active_power_phase_c: { label: 'Active Power Phase C', unit: 'kW', color: '#feca57' },
      voltage1: { label: 'Voltage A', unit: 'V', color: '#ff9ff3' },
      voltage2: { label: 'Voltage B', unit: 'V', color: '#54a0ff' },
      voltage3: { label: 'Voltage C', unit: 'V', color: '#5f27cd' },
      voltage: { label: 'Voltage AVG', unit: 'V', color: '#00d2d3' },
      voltagell: { label: 'Voltage L-L', unit: 'V', color: '#ff6348' }
    };

    // Chart configuration
    const isMobile = window.innerWidth <= 767;
    const isTablet = window.innerWidth > 767 && window.innerWidth <= 1024;

    const fontSizeX = isMobile ? 7 : isTablet ? 11 : 13;
    const fontSizeY = isMobile ? 7 : isTablet ? 11 : 13;
    const tooltipTitleSize = isMobile ? 10 : isTablet ? 12 : 14;
    const tooltipBodySize = isMobile ? 9 : isTablet ? 11 : 13;

    const chartConfig = {
      type: 'line',
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            cornerRadius: 8,
            displayColors: false,
            titleFont: {
              size: tooltipTitleSize
            },
            bodyFont: {
              size: tooltipBodySize
            },
            callbacks: {
              label: function (context) {
                const dataType = currentDataType[context.chart.canvas.id.slice(-1)];
                const config = dataTypeConfig[dataType];
                return `${config.label}: ${context.raw} ${config.unit}`;
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              color: 'rgba(0, 0, 0, 0.05)',
              drawBorder: false
            },
            ticks: {
              maxTicksLimit: 12,
              font: {
                size: fontSizeX
              },
              callback: function (value) {
                const label = this.getLabelForValue(value);
                const hour = parseInt(label.split(':')[0]);
                return hour % 2 === 0 && label.endsWith(':00') ? label : '';
              }
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)',
              drawBorder: false
            },
            ticks: {
              font: {
                size: fontSizeY
              },
              callback: function (value) {
                const buildingId = this.chart.canvas.id.slice(-1);
                const dataType = currentDataType[buildingId];
                const config = dataTypeConfig[dataType];
                return value + ' ' + config.unit;
              }
            }
          }
        },
        elements: {
          line: {
            tension: 0.4
          },
          point: {
            radius: 0,
            hoverRadius: 6,
            backgroundColor: '#fff',
            borderWidth: 2
          }
        }
      }
    };

    // Change data type function
    function changeDataType(buildingId) {
      const selector = document.getElementById(`dataTypeSelector${buildingId}`);
      const selectedType = selector.value;

      currentDataType[buildingId] = selectedType;

      // Update chart title
      const config = dataTypeConfig[selectedType];
      document.getElementById(`chartTitle${buildingId}`).textContent = config.label;

      // Update chart with existing data
      if (chartData[buildingId] && chartData[buildingId].length > 0) {
        updateChartWithDataType(buildingId, chartData[buildingId]);
      }
    }

    // Update chart with specific data type
    function updateChartWithDataType(buildingId, data) {
      const chart = charts[buildingId];
      const dataType = currentDataType[buildingId];
      const config = dataTypeConfig[dataType];
      const newData = new Array(1440).fill(null);

      if (data && Array.isArray(data)) {
        data.forEach(entry => {
          if (entry.timestamp) {
            const [hour, minute] = entry.timestamp.split('T')[1].split(':');
            const index = parseInt(hour) * 60 + parseInt(minute);
            if (index >= 0 && index < 1440) {
              let value = 0;

              // Map data based on selected type
              switch (dataType) {
                case 'current':
                  value = entry.current || 0;
                  break;
                case 'power':
                  value = entry.power || entry.active_power || 0;
                  break;
                case 'voltage':
                  value = entry.voltage || 0;
                  break;

                default:
                  value = entry.power || entry.active_power || 0;
              }

              newData[index] = value;
            }
          }
        });
      }

      // Update chart color based on data type
      chart.data.datasets[0].borderColor = config.color;
      chart.data.datasets[0].data = newData;

      // Update gradient
      const ctx = chart.ctx;
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      const color = config.color;
      const rgb = hexToRgb(color);
      gradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`);
      gradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.05)`);
      chart.data.datasets[0].backgroundColor = gradient;

      chart.update('none');
    }

    // Helper function to convert hex to rgb
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : { r: 102, g: 126, b: 234 };
    }

    // Date formatting
    function formatDate(date, period) {
      switch (period) {
        case 'day':
          return date.toLocaleDateString('en-GB');
        case 'month':
          return date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
        case 'year':
          return date.getFullYear().toString();
        case 'lifetime':
          return 'All Time';
        default:
          return date.toLocaleDateString('en-GB');
      }
    }

    // Period management
    function setPeriod(period) {
      currentPeriod = period;

      // Update tab appearance
      document.querySelectorAll('.period-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update date display
      updateDateDisplay();

      // Refresh data for new period
      refreshAllData();
    }

    // Date navigation
    function navigateDate(direction) {
      switch (currentPeriod) {
        case 'day':
          currentDate.setDate(currentDate.getDate() + direction);
          break;
        case 'month':
          currentDate.setMonth(currentDate.getMonth() + direction);
          break;
        case 'year':
          currentDate.setFullYear(currentDate.getFullYear() + direction);
          break;
        case 'lifetime':
          return; // No navigation for lifetime
      }

      updateDateDisplay();
      refreshAllData();
    }

    // Update date display
    function updateDateDisplay() {
      const display = document.getElementById('currentDateDisplay');
      display.textContent = formatDate(currentDate, currentPeriod);
    }

    // Date picker functions
    function openDatePicker() {
      if (currentPeriod === 'lifetime') return;

      // This opens the main date picker that affects all charts
      document.getElementById('dateModal').style.display = 'flex';
      currentBuilding = 0; // Indicates global date change

      // Set max date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('datePicker').setAttribute('max', today);
      document.getElementById('datePicker').value = currentDate.toISOString().split('T')[0];
    }

    function fetchHistoricalData() {
      const selectedDate = document.getElementById('datePicker').value;
      if (!selectedDate) {
        alert('Please select a date');
        return;
      }

      currentDate = new Date(selectedDate);
      updateDateDisplay();

      // Load data for the selected date
      fetchHistoricalDataForDate(1, 'Clinic', selectedDate);
      updateChartDateDisplay(1, selectedDate);

      closeModal();
    }

    function closeModal() {
      document.getElementById('dateModal').style.display = 'none';
    }

    // Initialize charts
    function initializeChart(buildingId) {
      const ctx = document.getElementById(`energyChart${buildingId}`).getContext('2d');

      const config = dataTypeConfig[currentDataType[buildingId]];
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      const rgb = hexToRgb(config.color);
      gradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`);
      gradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.05)`);

      const chartConfigCopy = {
        ...chartConfig,
        data: {
          labels: Array.from({ length: 1440 }, (_, i) => {
            const hours = Math.floor(i / 60).toString().padStart(2, '0');
            const minutes = (i % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}`;
          }),
          datasets: [{
            label: config.label,
            data: new Array(1440).fill(null),
            borderColor: config.color,
            backgroundColor: gradient,
            fill: true,
            borderWidth: isMobile ? 1 : 2
          }]
        }
      };

      charts[buildingId] = new Chart(ctx, chartConfigCopy);

      // Update chart title
      document.getElementById(`chartTitle${buildingId}`).textContent = config.label;
    }

    function startRealTime(buildingId) {
      clearInterval(realTimeIntervals[buildingId]);

      const endpoint = 'Clinic';

      realTimeIntervals[buildingId] = setInterval(() => {
        fetchRealTimeData(buildingId, endpoint);
      }, 3000);

      updateChartDateDisplay(buildingId, new Date().toISOString().split('T')[0]);
    }

    // Fetch real-time data
    async function fetchRealTimeData(buildingId, endpoint) {
      try {
        const response = await fetch(`https://api-kx4r63rdjq-an.a.run.app/latest-day-energy/sensor${endpoint}`);
        if (!response.ok) throw new Error('Failed to fetch data');

        const data = await response.json();
        chartData[buildingId] = data.data;
        updateChartWithDataType(buildingId, data.data);

        // Calculate and update daily energy for this building
        calculateAndUpdateDailyEnergy(buildingId, data.data);
      } catch (error) {
        console.error('Error fetching real-time data:', error);
      }
    }

    // ฟังก์ชันคำนวณ Daily Energy ที่แก้ไขแล้ว
    function calculateAndUpdateDailyEnergy(buildingId, data) {
      if (!data || !Array.isArray(data) || data.length === 0) {
        const elementId = buildingId === 1 ? 'daily-energy' : 'dailyValue2';
        document.getElementById(elementId).textContent = '0.00';
        return;
      }

      // จัดเรียงข้อมูลตามเวลา เผื่อ API ส่งลำดับมั่ว
      data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      let totalEnergy = 0;
      let intervalStartTime = null;
      let powerSum = 0;
      let countPower = 0;

      data.forEach(entry => {
        const power = entry.active_power || entry.power || 0;
        if (power != null && !isNaN(power) && power > 0) {
          if (!intervalStartTime) {
            intervalStartTime = new Date(entry.timestamp);
          }
          powerSum += power;
          countPower++;

          const currentTime = new Date(entry.timestamp);
          const diffMinutes = (currentTime - intervalStartTime) / 1000 / 60;

          if (diffMinutes >= 15) {
            const avgPower = powerSum / countPower;
            totalEnergy += avgPower * (15 / 60); // 15 นาที = 0.25 ชั่วโมง
            // เริ่มช่วงใหม่
            intervalStartTime = currentTime;
            powerSum = 0;
            countPower = 0;
          }
        }
      });

      // ถ้าช่วงสุดท้ายมีข้อมูลแต่ไม่ครบ 15 นาที ก็คิดให้
      if (countPower > 0) {
        const avgPower = powerSum / countPower;
        totalEnergy += avgPower * (15 / 60);
      }

      const elementId = buildingId === 1 ? 'daily-energy' : 'dailyValue2';
      document.getElementById(elementId).textContent = totalEnergy.toFixed(2);
    }

    // Update individual chart date display
    function updateChartDateDisplay(buildingId, date) {
      document.getElementById(`dateDisplay${buildingId}`).textContent = `Date: ${date}`;
    }

    // Fetch bill data
    async function fetchBillData(buildingId, period, endpoint) {
      try {
        const response = await fetch(`https://api-kx4r63rdjq-an.a.run.app/${period}-bill/sensor${endpoint}`);
        if (!response.ok) throw new Error('Failed to fetch bill data');

        const data = await response.json();
        const billValue = data.electricity_bill || '-';

        if (period === 'monthly') {
          document.getElementById(`monthly-energy`).textContent = billValue;
          document.getElementById(`monthValue2`).textContent = billValue;
        } else if (period === 'yearly') {
          document.getElementById(`yearly-energy`).textContent = billValue;
          document.getElementById(`yearValue2`).textContent = billValue;
        }
      } catch (error) {
        console.error(`Error fetching ${period} bill:`, error);
        if (period === 'monthly') {
          document.getElementById(`monthly-energy`).textContent = 'Error';
          document.getElementById(`monthValue2`).textContent = 'Error';
        } else if (period === 'yearly') {
          document.getElementById(`yearly-energy`).textContent = 'Error';
          document.getElementById(`yearValue2`).textContent = 'Error';
        }
      }
    }


    // Refresh all data based on current period and date
    function refreshAllData() {
      // Update bill labels based on period
      updateBillLabels();

      // Fetch appropriate data based on current period
      if (currentPeriod === 'day') {
        // For daily view, load specific date data
        const dateStr = currentDate.toISOString().split('T')[0];

        // Load historical data for both buildings
        fetchHistoricalDataForDate(1, 'Clinic', dateStr);


        // Update chart date displays
        updateChartDateDisplay(1, dateStr);
        updateChartDateDisplay(2, dateStr);
      } else {
        // For other periods, start real-time monitoring
        startRealTime(1);

      }

      // Fetch bill data
      fetchAllBillData();
    }

    // Fetch historical data for specific date and calculate daily energy
    async function fetchHistoricalDataForDate(buildingId, endpoint, date) {
      try {
        const response = await fetch(`https://api-kx4r63rdjq-an.a.run.app/daily-energy/sensor${endpoint}?date=${date}`);
        if (!response.ok) throw new Error('Failed to fetch historical data');

        const data = await response.json();
        chartData[buildingId] = data.data;


        updateChartWithDataType(buildingId, data.data);

        // Calculate and update daily energy for the selected date
        calculateAndUpdateDailyEnergy(buildingId, data.data);

      } catch (error) {
        console.error(`Error fetching historical data for building ${buildingId}:`, error);
        // Clear chart data on error
        const chart = charts[buildingId];
        chart.data.datasets[0].data = new Array(1440).fill(null);
        chart.update('none');
        chartData[buildingId] = [];

        // Set daily energy to 0 on error
        const elementId = buildingId === 1 ? 'daily-energy' : 'dailyValue2';
        document.getElementById(elementId).textContent = '0.00';
      }
    }

    // Update bill labels based on current period
    function updateBillLabels() {
      const labels = {
        day: 'Daily Energy',
        month: 'Monthly Energy',
        year: 'Yearly Energy',
        lifetime: 'Total Energy'
      };

      // Update labels for both buildings
      [1].forEach(buildingId => {
        document.querySelector(`#billBox${buildingId} .metric-label`).textContent = labels[currentPeriod];
        document.querySelector(`#monthBox${buildingId} .metric-label`).textContent =
          currentPeriod === 'day' ? 'Monthly Energy' : `${currentPeriod.charAt(0).toUpperCase() + currentPeriod.slice(1)} Energy`;
        document.querySelector(`#yearBox${buildingId} .metric-label`).textContent =
          currentPeriod === 'day' ? 'Yearly Energy' : `Total Energy`;
      });
    }

    // Fetch all bill data
    function fetchAllBillData() {
      // Always fetch monthly and yearly data
      fetchBillData(1, 'monthly', 'Clinic');
      fetchBillData(1, 'yearly', 'Clinic');

    }

    // Initialize everything
    function initialize() {
      // Initialize charts
      initializeChart(1);

      // Set initial date display
      updateDateDisplay();

      // Set max date to today for date picker
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('datePicker').setAttribute('max', today);

      // Load initial data
      refreshAllData();

      // Update bill data every minute (only for monthly/yearly, not daily as it's calculated from chart data)
      setInterval(() => {
        fetchAllBillData();
      }, 60000);
    }

    // Close modal when clicking outside
    document.getElementById('dateModal').addEventListener('click', function (e) {
      if (e.target === this) closeModal();
    });

    // Keyboard navigation
    document.addEventListener('keydown', function (e) {
      if (e.key === 'ArrowLeft') {
        navigateDate(-1);
      } else if (e.key === 'ArrowRight') {
        navigateDate(1);
      } else if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Check authentication on page load
    window.addEventListener('load', function () {
      checkAuth();
    });

    // Export functions
    async function fetchDailyData(buildingId, date) {
      const endpoint = 'Clinic';
      try {
        const response = await fetch(`https://api-kx4r63rdjq-an.a.run.app/daily-energy/sensor${endpoint}?date=${date}`);
        if (!response.ok) throw new Error('No data');
        const data = await response.json();
        data.data.forEach(d => d.export_date = date);
        return data.data;
      } catch {
        return [];
      }
    }

    async function fetchDateRangeData(buildingId, startDate, endDate) {
      const allData = [];
      let current = new Date(startDate);
      const end = new Date(endDate);
      while (current <= end) {
        const dateStr = current.toISOString().split('T')[0];
        const dailyData = await fetchDailyData(buildingId, dateStr);
        allData.push(...dailyData);
        current.setDate(current.getDate() + 1);
      }
      return allData;
    }

    // 1. ดึงข้อมูลช่วงวันที่ (วันแรก-วันสุดท้าย ของเดือน หรือ ปี)
    async function fetchDateRangeDataForEnergy(buildingId, startDate, endDate) {
      const allDailyEnergies = []; // เก็บพลังงานรายวันแต่ละวัน

      let currentDate = new Date(startDate);
      const lastDate = new Date(endDate);

      while (currentDate <= lastDate) {
        const dateStr = currentDate.toISOString().split('T')[0];
        const dailyData = await fetchDailyData(buildingId, dateStr); // ดึงข้อมูล 15 นาทีรายวัน
        const dailyEnergy = calculateDailyEnergyFromData(dailyData); // คำนวณพลังงานรายวันจากข้อมูลนี้
        allDailyEnergies.push(dailyEnergy);

        currentDate.setDate(currentDate.getDate() + 1);
      }

      // รวมพลังงานรายวันทั้งหมดเป็นพลังงานเดือนหรือปี
      const totalEnergy = allDailyEnergies.reduce((sum, val) => sum + val, 0);
      return totalEnergy;
    }

    // 2. ฟังก์ชันคำนวณพลังงานรายวันแบบแยก (ไม่อัพเดต UI)
    function calculateDailyEnergyFromData(data) {
      if (!data || !Array.isArray(data) || data.length === 0) return 0;
      data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      let totalEnergy = 0;
      let intervalStartTime = null;
      let powerSum = 0;
      let countPower = 0;

      data.forEach(entry => {
        const power = entry.active_power || entry.power || 0;
        if (power != null && !isNaN(power) && power > 0) {
          if (!intervalStartTime) intervalStartTime = new Date(entry.timestamp);
          powerSum += power;
          countPower++;

          const currentTime = new Date(entry.timestamp);
          const diffMinutes = (currentTime - intervalStartTime) / 1000 / 60;

          if (diffMinutes >= 15) {
            const avgPower = powerSum / countPower;
            totalEnergy += avgPower * (15 / 60);
            intervalStartTime = currentTime;
            powerSum = 0;
            countPower = 0;
          }
        }
      });

      if (countPower > 0) {
        const avgPower = powerSum / countPower;
        totalEnergy += avgPower * (15 / 60);
      }

      return totalEnergy;
    }
  </script>
  <script>
    document.querySelectorAll('.metric-card').forEach(card => {
      card.addEventListener('click', () => {
        const label = card.querySelector('.metric-label');
        const value = card.querySelector('.metric-value');
        const unit = card.querySelector('.metric-unit');

        if (!card.classList.contains('flipped')) {
          card.dataset.oldLabel = label.textContent;
          card.dataset.oldValue = value.textContent;
          card.dataset.oldUnit = unit.textContent;

          // แปลง &#10; หรือ \n เป็น <br> 
          const descRaw = card.dataset.description || 'ไม่มีคำอธิบาย';
          // แทนที่ newline จริง ๆ (บางเบราว์เซอร์อาจได้ \n หรือ &#10;)
          const descHTML = descRaw.replace(/(?:\r\n|\r|\n|&#10;)/g, '<br>');

          label.innerHTML = descHTML;
          value.textContent = '';
          unit.textContent = '';

          card.classList.add('flipped');
        } else {
          label.textContent = card.dataset.oldLabel;
          value.textContent = card.dataset.oldValue;
          unit.textContent = card.dataset.oldUnit;

          card.classList.remove('flipped');
        }
      });
    });
  </script>
  <script>
    const sky = document.getElementById("authOverlay");
    const numStars = 200; // จำนวนดาว

    for (let i = 0; i < numStars; i++) {
      const star = document.createElement("div");
      star.classList.add("star");

      // ขนาดดาวสุ่ม (1px - 3px)
      const size = Math.random() * 2 + 1;
      star.style.width = `${size}px`;
      star.style.height = `${size}px`;

      // ตำแหน่งสุ่ม
      star.style.top = `${Math.random() * 100}%`;
      star.style.left = `${Math.random() * 100}%`;

      // เวลา animation สุ่ม (1s - 5s)
      star.style.animationDuration = `${Math.random() * 4 + 1}s`;

      sky.appendChild(star);
    }


    function initialize() {
      // สร้างกราฟก่อน
      initializeChart(1);

      // ตั้งค่าระบบแจ้งเตือน (โหลด log/ปุ่ม)
      setupNotifications();

      // ✅ ติดตั้ง hook ตอนนี้ (ทุกฟังก์ชันพื้นฐานถูกประกาศแล้ว และกราฟถูกสร้างแล้ว)
      installNotificationHooks();

      // ที่เหลือตามเดิม
      updateDateDisplay();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('datePicker').setAttribute('max', today);
      refreshAllData();
      setInterval(() => { fetchAllBillData(); }, 60000);
    }

  </script>
</body>

</html>